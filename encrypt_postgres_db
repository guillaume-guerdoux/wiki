##‚≠ê OPTION 1 ‚Äî Create an encrypted container for PostgreSQL
### Step 1 ‚Äî Create a directory to store the encrypted file

```
sudo mkdir /secure
```

### Step 2 ‚Äî Create a 10GB encrypted container file

(Adjust size based on your actual DB size)

```
sudo dd if=/dev/zero of=/secure/pgdata.img bs=1M count=10000
```

### Step 3 ‚Äî Encrypt the container with LUKS

```
sudo cryptsetup luksFormat /secure/pgdata.img
```
Open it:

```
sudo cryptsetup open /secure/pgdata.img pgdata_crypt
```

Now you have a device:
```
/dev/mapper/pgdata_crypt
```

### Step 4 ‚Äî Format it
```
sudo mkfs.ext4 /dev/mapper/pgdata_crypt
```

### Step 5 ‚Äî Create mount point
```
sudo mkdir /mnt/pgdata_crypt
```

Mount it:

```
sudo mount /dev/mapper/pgdata_crypt /mnt/pgdata_crypt
```

Give permissions
```
sudo chown -R postgres:postgres /mnt/pgdata_crypt
sudo chmod 700 /mnt/pgdata_crypt
```

### Step 6 ‚Äî Stop PostgreSQL

```
sudo systemctl stop postgresql
```

### Step 7 ‚Äî Move PostgreSQL‚Äôs data directory
Find your data directory:
```
sudo -u postgres psql -c "show data_directory;"
```

Move it:

```
sudo rsync -av /var/lib/postgresql/15/main/ /mnt/pgdata_crypt/
```

Rename original folder to avoid conflicts:
```
sudo mv /var/lib/postgresql/15/main /var/lib/postgresql/15/main.bak
```

### Step 8 ‚Äî Update PostgreSQL config
Edit
```
/etc/postgresql/15/main/postgresql.conf
```

Find:
```
data_directory = '/var/lib/postgresql/15/main'
```

Replace:

```
data_directory = '/mnt/pgdata_crypt/main'
```

### Step 9 ‚Äî Start PostgreSQL again
```
sudo systemctl start postgresql
```


## Restart server - How to unlock it

### ‚úÖ 1. Unlock the LUKS encrypted device
```
sudo cryptsetup open /secure/pgdata.img pgcrypt
```

### ‚úÖ 2. Mount the decrypted filesystem
```
sudo mount /dev/mapper/pgcrypt /mnt/pgdata_crypt
```

###‚úÖ 3. Start PostgreSQL

Once the encrypted volume is mounted, start the database:
```
sudo systemctl start postgresql@12-main
```

```
sudo systemctl status postgresql@12-main
```

## Set up an automatic mount on restart
### Option 1 ‚Äî Auto-unlock with a local keyfile (Most common, fully automatic)

### 1. Generate a keyfile
```
sudo dd if=/dev/urandom of=/root/pg_luks.key bs=4096 count=1
sudo chmod 400 /root/pg_luks.key
```

### 2. Add the keyfile to the LUKS volume
```
sudo cryptsetup luksAddKey /secure/pgdata.img /root/pg_luks.key
```

### Step 2 ‚Äî Create systemd service to set up loop + unlock + mount
Edit:

```
sudo nano /etc/systemd/system/pgdata.service

```

Add:
```
[Unit]
Description=Setup PostgreSQL encrypted data
After=local-fs.target
Before=postgresql@12-main.service
Wants=postgresql@12-main.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/mount_pgdata.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target


```
### Step 3 ‚Äî Create the script /usr/local/bin/mount_pgdata.sh
```
sudo nano /usr/local/bin/mount_pgdata.sh
```

```
#!/bin/bash
# Step 2: Unlock LUKS container
sudo cryptsetup luksOpen /secure/pgdata.img pgcrypt --key-file /root/pg_luks.key

# Step 3: Mount filesystem read-write
sudo mount -o rw /dev/mapper/pgcrypt /mnt/pgdata_crypt
```

```
sudo chmod +x /usr/local/bin/mount_pgdata.sh
```

### Step 4 ‚Äî Ensure PostgreSQL waits for it
```
sudo systemctl edit postgresql@12-main
```

Add this:

```
[Unit]
After=mnt-pgdata_crypt.mount
Requires=mnt-pgdata_crypt.mount

```

### Step 5 ‚Äî Enable the service
```
sudo systemctl daemon-reload
sudo systemctl enable pgdata.service
sudo systemctl enable postgresql@12-main

```

### üîÑ Step 6 ‚Äî Reboot and test
```
sudo reboot
```
